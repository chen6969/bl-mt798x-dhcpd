name: Build FIT BL2 and FIP

on:
  workflow_dispatch:
    inputs:
      TARGET:
        description: 'Build target (format: soc,board). Default: all. e.g. mt7981,cmcc_a10 | mt7986,redmi_ax6000'
        required: true
        default: 'all'
        type: string
      OC_BL2:
        description: 'Build 1.6GHz BL2 by patch (mt7981 only)'
        required: false
        default: false
        type: boolean
      CUSTOM_IP:
        description: 'Custom default IP for DHCPD (e.g. 192.168.31.1)'
        required: false
        default: 'false'
        type: string
      UBOOT_VERSIONS:
        description: 'Select U-Boot&ATF build version'
        required: true
        default: '2022'
        type: choice
        options:
          - 2022
          - 2023
          - 2024
          - 2025

env:
  TZ: Asia/Shanghai
  # 交叉编译链，和你的build.sh保持一致
  TOOLCHAIN: aarch64-linux-gnu-

permissions:
  contents: write

jobs:
  generate_list:
    name: Generate build list
    runs-on: ubuntu-latest
    outputs:
      list: ${{ steps.list.outputs.list }}
      timestamp: ${{ steps.ts.outputs.timestamp }}

    steps:
      - name: Checkout source tree
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      - name: Generate timestamp
        id: ts
        run: |
          echo "timestamp=$(date -u +%Y%m%d%H%M%S)" >> "$GITHUB_OUTPUT"

      - name: Generate build list
        id: list
        run: |
          set -euo pipefail
          PATCH_FILE="modify-patch/0002-uboot-2022-fit-merge-code-from-1715173329-to-support.patch"
          if [ ! -f "$PATCH_FILE" ]; then
            echo "ERROR: Patch file not found: $PATCH_FILE" >&2
            exit 1
          fi

          CONFIG_LIST="$(
            awk '/^diff --git a\// {print $4}' "$PATCH_FILE" \
              | sed 's/^b\///' \
              | awk -F '/' '/defconfig$/ {print $NF}' \
              | sort -u
          )"

          if [ -z "$CONFIG_LIST" ]; then
            echo "No *defconfig entries found in patch: $PATCH_FILE" >&2
            exit 1
          fi

          TARGET_RAW="${{ github.event.inputs.TARGET }}"
          TARGET_RAW="${TARGET_RAW:-all}"
          TARGET="$(echo "$TARGET_RAW" | tr -d '[:space:]')"
          SELECT_VER="${{ github.event.inputs.UBOOT_VERSIONS }}"

          if [ -n "$TARGET" ] && [ "$TARGET" != "all" ]; then
            if ! echo "$TARGET" | grep -Eq '^[A-Za-z0-9_.-]+,[A-Za-z0-9_.-]+$'; then
              echo "Illegal TARGET: '$TARGET_RAW' (expected: soc,board). e.g. mt7981,cmcc_a10 | mt7986,redmi_ax6000" >&2
              exit 1
            fi

            SOC="${TARGET%%,*}"
            BOARD="${TARGET#*,}"
            DEFCONFIG="${SOC}_${BOARD}_defconfig"

            if echo "$CONFIG_LIST" | grep -Fxq "$DEFCONFIG"; then
              echo "TARGET matched patch list: $DEFCONFIG"
            else
              if ! find . -path "*configs/${DEFCONFIG}" -type f -print -quit | grep -q .; then
                echo "TARGET defconfig not found: $DEFCONFIG" >&2
                echo "Available defconfigs from patch list:" >&2
                echo "$CONFIG_LIST" | sed 's/^/  - /' >&2
                exit 1
              fi
              echo "TARGET found in tree (not in patch list): $DEFCONFIG"
            fi

            JSON_LIST="{\"runner\": [\"ubuntu-latest\"],\"list\": [{\"defconfig\":\"${DEFCONFIG}\",\"version\":\"${SELECT_VER}\"}]}"
            echo "$JSON_LIST" | jq .
            echo "list=$JSON_LIST" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CONFIGS=""
          for cfg in $CONFIG_LIST; do
            CONFIGS+="{\"defconfig\":\"${cfg}\",\"version\":\"${SELECT_VER}\"},"
          done
          CONFIGS="$(echo "${CONFIGS%,}")"
          JSON_LIST="{\"runner\": [\"ubuntu-latest\"],\"list\": [${CONFIGS}]}"
          echo "$JSON_LIST" | jq .
          echo "list=$JSON_LIST" >> "$GITHUB_OUTPUT"

  build:
    name: Build ${{ matrix.list.defconfig }} (ver ${{ matrix.list.version }})
    needs: generate_list
    runs-on: ${{ matrix.runner }}
    env:
      TIMESTAMP: ${{ needs.generate_list.outputs.timestamp }}
    strategy:
      matrix: ${{ fromJson(needs.generate_list.outputs.list) }}
      fail-fast: false
      max-parallel: 15

    steps:
      - name: Install all dependencies (critical for build.sh)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get update -y
          # 交叉编译链 + 编译依赖 + python3(必须)
          sudo -E apt-get install -y gcc-aarch64-linux-gnu build-essential flex bison libssl-dev device-tree-compiler python3
          sudo timedatectl set-timezone "$TZ"
          # 校验依赖是否安装成功
          command -v aarch64-linux-gnu-gcc
          command -v python3
          echo "All dependencies installed success!"

      - name: Checkout source tree
        uses: actions/checkout@v4

      - name: Apply required FIT patch
        run: |
          git apply --verbose --ignore-space-change --ignore-whitespace "modify-patch/0002-uboot-2022-fit-merge-code-from-1715173329-to-support.patch"

      - name: Apply overclocking BL2 patch (1.6GHz mt7981)
        if: ${{ inputs.OC_BL2 == true }}
        run: |
          git apply --verbose --ignore-space-change --ignore-whitespace "modify-patch/0001-overclocking-mt7981-to-1.6GHz-by-modify-atf.patch"

      - name: Apply custom DHCP IP patch
        if: ${{ github.event.inputs.CUSTOM_IP != 'false' && github.event.inputs.CUSTOM_IP != '' && !cancelled() }}
        run: |
          set -euo pipefail
          CUSTOM_IP="${{ github.event.inputs.CUSTOM_IP }}"
          if [[ "$CUSTOM_IP" == "false" || -z "$CUSTOM_IP" ]]; then exit 0; fi
          
          if ! echo "$CUSTOM_IP" | grep -Eq '^[0-9]{1,3}(\.[0-9]{1,3}){3}$'; then
            echo "Illegal CUSTOM_IP: $CUSTOM_IP"
            exit 1
          fi

          PREFIX="$(echo "$CUSTOM_IP" | awk -F. '{print $1"."$2"."$3}')"
          POOL_START="${PREFIX}.100"
          POOL_END="${PREFIX}.200"

          echo "Set DHCP IP: $CUSTOM_IP, Pool: $POOL_START ~ $POOL_END"
          count=0
          for f in uboot-mtk-*/net/mtk_dhcpd.c atf-*/plat/mediatek/drivers/dhcpd/dhcpd.c; do
            if [ -f "$f" ]; then
              sed -i -E \
                -e 's/^(#define[[:space:]]+DHCPD_DEFAULT_IP_STR[[:space:]]+")([^"]+)(")/\1'"$CUSTOM_IP"'\3/' \
                -e 's/^(#define[[:space:]]+DHCPD_POOL_START_STR[[:space:]]+")([^"]+)(")/\1'"$POOL_START"'\3/' \
                -e 's/^(#define[[:space:]]+DHCPD_POOL_END_STR[[:space:]]+")([^"]+)(")/\1'"$POOL_END"'\3/' \
                "$f"
              echo "Patched: $f"
              count=$((count+1))
            fi
          done
          if [ "$count" -eq 0 ]; then echo "Warning: DHCPD files not found"; fi

      - name: Build BL2 & FIP (core step, fit your build.sh 100%)
        run: |
          set -euo pipefail
          # ✅ 精准解析 SOC/BOARD，完美匹配你的build.sh要求
          export CONFIG="${{ matrix.list.defconfig }}"
          export SOC=$(echo "${CONFIG}" | awk -F '_' '{print $1}')
          export BOARD=$(echo "${CONFIG}" | sed -e 's/^'"${SOC}"'_//' -e 's/_defconfig$//')
          export VERSION="${{ matrix.list.version }}"
          export TOOLCHAIN="${{ env.TOOLCHAIN }}"
          
          # 兜底防解析失败，和build.sh的报错逻辑一致
          [ -z "$SOC" ] && export SOC="unknown_soc"
          [ -z "$BOARD" ] && export BOARD="unknown_board"

          mkdir -p "output"
          echo "========================================"
          echo "  Build Env Match build.sh"
          echo "  SOC: $SOC"
          echo "  BOARD: $BOARD"
          echo "  VERSION: $VERSION"
          echo "  CONFIG: $CONFIG"
          echo "  TOOLCHAIN: $TOOLCHAIN"
          echo "========================================"

          # ✅ 给build.sh加执行权限 + 用你的build.sh原生传参方式执行，零兼容问题
          chmod +x ./build.sh
          SOC=${SOC} BOARD=${BOARD} VERSION=${VERSION} ./build.sh 2>&1 | tee "output/build.log"
          
          # ✅ 终极根治409冲突：工件名称绝对唯一，永不重复
          UNIQ_TAG="${SOC}-${BOARD}-v${VERSION}-${CONFIG}-${{ env.TIMESTAMP }}"
          echo "ARTIFACT_NAME=${UNIQ_TAG}" >> "$GITHUB_ENV"

      - name: Organize build outputs
        run: |
          set -euo pipefail
          SUFFIX="-FIT-${{ matrix.list.version }}-${TIMESTAMP}"
          
          if [ "${{ inputs.OC_BL2 }}" = "true" ]; then
            for file in output/*bl2*.bin; do
              [ -f "$file" ] && mv -f "$file" "${file%.bin}_oc1.6GHz.bin"
            done
          fi

          shopt -s nullglob
          files=(output/*)
          if [ ${#files[@]} -eq 0 ]; then
            echo "ERROR: No build output files in output dir!"
            exit 1
          fi

          # 重新生成sha256校验文件，匹配重命名后的产物
          (
            cd output
            find . -maxdepth 1 -type f ! -name 'sha256sums*' -print0 | sort -z | xargs -0 sha256sum > "sha256sums${SUFFIX}.txt"
          )
          echo "Output files organized done!"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: output/*
          compression-level: 9

  release:
    name: Auto Release Firmware
    needs: [generate_list, build]
    runs-on: ubuntu-latest
    if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch)

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate release info
        run: |
          set -euo pipefail
          touch release.txt
          echo "- Build Target: ${{ github.event.inputs.TARGET }}" >> release.txt
          echo "- Build Version: ${{ github.event.inputs.UBOOT_VERSIONS }}" >> release.txt
          echo "- OC_BL2 1.6GHz: ${{ inputs.OC_BL2 == true && 'Enabled' || 'Disabled' }}" >> release.txt
          
          CUSTOM_IP="${{ github.event.inputs.CUSTOM_IP }}"
          if [ "$CUSTOM_IP" != "false" ] && [ -n "$CUSTOM_IP" ]; then
            echo "- Custom DHCP IP: $CUSTOM_IP" >> release.txt
          else
            echo "- DHCP IP: Default (192.168.1.1)" >> release.txt
          fi
          
          echo -e "\nFIT Code from: https://github.com/1715173329/bl-mt798x-oss/tree/fit-example" >> release.txt
          echo "Build by Yuzhii build.sh auto workflow" >> release.txt

          # Release标签带版本号，方便区分
          echo "TIMESTAMP=${{ needs.generate_list.outputs.timestamp }}" >> "$GITHUB_ENV"
          echo "RELEASE_TAG=FIT-Yuzhii-v${{ github.event.inputs.UBOOT_VERSIONS }}-${{ needs.generate_list.outputs.timestamp }}" >> "$GITHUB_ENV"
          echo "RELEASE_NAME=FIT-Yuzhii-v${{ github.event.inputs.UBOOT_VERSIONS }}-${{ needs.generate_list.outputs.timestamp }}" >> "$GITHUB_ENV"

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body_path: release.txt
          files: dist/**
          draft: false
          prerelease: false
